package org.xworkz.prodex.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;
import org.xworkz.prodex.dto.ProductPurchaseDto;
import org.xworkz.prodex.dto.EnrollmentDto;
import org.xworkz.prodex.service.MemberService;
import org.xworkz.prodex.service.ProductPurchaseService;

import javax.servlet.http.HttpSession;
import java.util.List;

@Controller
@RequestMapping("/member")
public class MemberController {

    @Autowired
    private ProductPurchaseService productPurchaseService;

    @Autowired
    private MemberService memberService;

    // ==========================================
    // 1. MEMBER DASHBOARD
    // ==========================================
    @GetMapping("/memberDashboardPage")
    public String memberDashboard(@RequestParam(value = "email", required = false) String email, Model model) {
        if (email == null || email.isEmpty()) {
            return "redirect:/loginPage?error=AUTH_REQUIRED";
        }

        // Fetch user history to show statistics on dashboard
        List<ProductPurchaseDto> history = productPurchaseService.findRequestsByMemberEmail(email);

        model.addAttribute("email", email);
        model.addAttribute("totalRequests", (history != null) ? history.size() : 0);

        // Optional: Count pending vs approved for dashboard badges
        long pendingCount = (history != null) ? history.stream()
                .filter(req -> "PENDING".equals(req.getStatus().toString())).count() : 0;
        model.addAttribute("pendingCount", pendingCount);

        return "memberDashboard";
    }

    // ==========================================
    // 2. PURCHASE HISTORY (MEMBER VIEW)
    // ==========================================
    @GetMapping("/viewPurchaseHistoryPage")
    public String viewHistory(@RequestParam("userEmail") String email, Model model) {
        // Fetch specific history for the logged-in member
        List<ProductPurchaseDto> history = productPurchaseService.findRequestsByMemberEmail(email);

        model.addAttribute("purchaseHistory", history);
        model.addAttribute("userEmail", email);
        return "viewPurchaseHistory"; // Ensure this JSP exists in /WEB-INF/views/
    }

    // ==========================================
    // 3. PROFILE MANAGEMENT
    // ==========================================
    @GetMapping("/editProfile")
    public String editProfilePage(@RequestParam("userEmail") String email, Model model) {
        EnrollmentDto user = memberService.findMemberByEmail(email);
        if (user == null) {
            return "redirect:/member/memberDashboardPage?email=" + email + "&error=USER_NOT_FOUND";
        }
        model.addAttribute("user", user);
        model.addAttribute("userEmail", email);
        return "editProfile";
    }

    // ==========================================
    // 4. AUTHENTICATION
    // ==========================================
    @GetMapping("/logout")
    public String memberLogout(HttpSession session, RedirectAttributes ra) {
        if (session != null) {
            session.invalidate();
        }
        ra.addFlashAttribute("successMessage", "You have been logged out successfully.");
        return "redirect:/loginPage";
    }
}